<template>
	<view class="message-list">
		<block v-for="(it,i) of messagesList" :key="i">
			<view class="uni-swipe-action">
				<view class="uni-swipe-action__container" @touchstart="touchStart" @touchmove="touchMove" @touchend="touchEnd"
				 @touchcancel="touchEnd" :style="{'transform':messageIndex == i ? transformX : 'translateX(0px)','-webkit-transform':messageIndex == i ? transformX : 'translateX(0px)'}"
				 :data-index="i" :data-disabled="it.disabled + 1">
					<view class="uni-swipe-action__content " @click="toMessageDetail(i)">
						<view class="item" :class=" i==0  ? 'stick' : ''">
							<view class="item-left">
								<image :src="it.faceUrl" class="image" />
							</view>
							<view class="item-middle">
								<text class="title">{{it.title}}</text>
								<text class="message">{{it.message}}</text>
							</view>
							<view class="item-right">
								<view class="time">{{it.time}}</view>
								<view class="mark" v-if="it.count>0">{{it.count}}</view>
							</view>
						</view>
						<!-- <view  class="line"></view> -->
					</view>
					<view class="uni-swipe-action__btn-group" :id="elId">
						<div v-for="(item,index) in options" :key="index" class="uni-swipe-action--btn" :style="{backgroundColor: item.style && item.style.backgroundColor ? item.style.backgroundColor : '#C7C6CD',color: item.style && item.style.color ? item.style.color : '#FFFFFF',fontSize: item.style && item.style.fontSize ? item.style.fontSize : '28upx'}"
						 @click="bindClickBtn(item,i)">
							{{item.text }}
						</div>
					</view>
				</view>
			</view>
		</block>
	</view>
</template>

<script>
	export default {
		name: 'uni-swipe-action',
		props: {
			options: Array,
			messagesList: Array,
		},

		data() {
			const elId = `Uni_${Math.ceil(Math.random() * 10e5).toString(36)}`
			return {
				elId: elId,
				transformX: 'translateX(0px)',
				messageIndex: -1
			}
		},
		created() {
			this.direction = ''
			this.startX = 0
			this.startY = 0
			this.btnGroupWidth = 0
			this.isMoving = false
			this.startCilentY = 0
		},
		// #ifdef H5
		mounted() {
			this.getSize()
		},
		// #endif
		// #ifndef H5
		onReady() {
			this.getSize()
		},
		// #endif
		methods: {
			//index为该消息对象在messagesList中的下标
			toMessageDetail(index) {
				this.$emit('clickMessage', index); //向外触发点击了消息,带上点击的消息的下标			
			},
			getSize() {
				uni.createSelectorQuery().in(this).select(`#${this.elId}`).boundingClientRect().exec((ret) => {
					this.btnGroupWidth = ret[0].width;
				});
			},
			//删除或置顶的按钮点击事件
			bindClickBtn(item, index) {
				if (item.tag == 1) {
					this.messagesList.unshift(this.messagesList[index]) //向数组顶部添加元素
					this.messagesList.splice(index + 1, 1) //删除原来位置的元素
				}
				if (item.tag == 0) {
					this.messagesList.splice(index, 1)
				}
				this.messageIndex = -1;
				console.log(item.text + 'message第' + index + '项');
			},
			touchStart(event) {
				if (event.currentTarget.dataset.disabled === true) {
					return;
				}
				this.touchStatus = true;
				this.startX = event.touches[0].pageX;
				this.startY = event.touches[0].pageY;
				this.startCilentY = event.touches[0].clientY; //单条消息组件开始距离窗口顶部的高度
			},
			touchMove(event) {
				let endCilentY = event.touches[0].clientY; //单条消息组件滑动距离窗口顶部的高度
				let moveClientY = endCilentY - this.startCilentY; //单条消息组件在屏幕的y轴上移动的距离
				//如果在y轴上移动距离过大,(比如大于20),说明用户在下拉或上推,取消左右滑动
				if (this.direction === 'Y' || Math.abs(moveClientY) > 20 || event.currentTarget.dataset.disabled === true) {
					this.direction = '';
					return;
				}
				var moveY = event.touches[0].pageY - this.startY,
					moveX = event.touches[0].pageX - this.startX;
				this.direction = moveX > 0 ? 'right' : 'left';
				this.messageIndex = moveX < 0 ? event.currentTarget.dataset.index : -1;
				this.isMoving = true;

			},
			touchEnd(event) {
				this.isMoving = false;
				if (this.direction != 'right' && this.direction != 'left') {
					this.direction = '';
					return;
				}
				if (this.direction == 'right') {
					this.messageIndex = -1;
				}
				this.endMove(event)
			},
			endMove(event) {
				if (this.direction === 'Y' || event.currentTarget.dataset.disabled === true) {
					this.direction = '';
					return;
				}
				if (this.messageIndex !== -1) {
					this.transformX = `translateX(${-this.btnGroupWidth}px)`;
					this.$emit('opened');
				} else {
					this.transformX = 'translateX(0px)';
					this.$emit('closed');
				}
				this.direction = '';
			}
		}
	}
</script>

<style lang="scss">
	.uni-swipe-action {
		width: 100%;
		overflow: hidden;

		&__container {
			background-color: #FFFFFF;
			width: 200%;
			display: flex;
			flex-direction: row;
			flex-wrap: wrap;
			transition: transform 100ms cubic-bezier(.165, .84, .44, 1);
		}

		&__content {
			width: 50%;
		}

		&__btn-group {
			display: flex;
			flex-direction: row;
		}

		&--btn {
			padding: 0 32upx;
			color: #FFFFFF;
			background-color: #C7C6CD;
			font-size: 28upx;
			display: inline-flex;
			text-align: center;
			flex-direction: row;
			align-items: center;
		}
	}

	.item:active {
		background-color: #eeeeee;
	}

	.item {
		display: flex;
		flex-direction: row;
		justify-content: space-between;
		padding: 10upx 16upx;
		background-color: #fff;
		border-bottom: 1px solid rgb(243, 243, 243);

		&.stick {
			background-color: rgba(243, 236, 221, .5);
		}

		.item-left {
			text-align: center;

			.image {
				width: 100upx;
				height: 100upx;
				border-radius: 50upx;
				background-color: #eee;
			}
		}

		.item-middle {
			display: flex;
			flex: 1;
			flex-wrap: wrap;
			flex-direction: row;
			justify-content: flex-start;
			margin-left: 10upx;
			overflow: hidden;

			.title {
				width: 100%;
				color: #000;
				font-family: "微软雅黑";
				font-weight: 400;
				font-size: 30upx;
				height: 50upx;
				line-height: 60upx;
				overflow: hidden;
				/*自动隐藏文字*/
				text-overflow: ellipsis;
				/*文字隐藏后添加省略号*/
				white-space: nowrap;
				/**强制不换行*/
			}

			.message {
				width: 100%;
				font-family: "微软雅黑";
				color: #808080;
				height: 50upx;
				line-height: 40upx;
				font-size: 24upx;
				overflow: hidden;
				/**自动隐藏文字*/
				text-overflow: ellipsis;
				/**文字隐藏后添加省略号*/
				white-space: nowrap;
				/**强制不换行*/
			}
		}

		.item-right {
			overflow: hidden;
			display: flex;
			flex-direction: column;
			align-items: center;

			.time {
				color: #808080;
				font-size: 18upx;
				height: 60upx;
				line-height: 60upx;
			}

			.mark {
				background-color: #f74c31;
				line-height: 35upx;
				text-align: center;
				font-size: 18upx;
				min-width: 35upx;
				min-height: 35upx;
				border-radius: 18upx;
				color: #fff;
			}
		}
	}
</style>
